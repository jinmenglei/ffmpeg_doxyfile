\hypertarget{aaccoder__twoloop_8h}{}\doxysection{E\+:/github/ffmpeg/libavcodec/aaccoder\+\_\+twoloop.h File Reference}
\label{aaccoder__twoloop_8h}\index{E:/github/ffmpeg/libavcodec/aaccoder\_twoloop.h@{E:/github/ffmpeg/libavcodec/aaccoder\_twoloop.h}}
{\ttfamily \#include $<$float.\+h$>$}\newline
{\ttfamily \#include \char`\"{}libavutil/mathematics.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}mathops.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}avcodec.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}put\+\_\+bits.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aac.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aacenc.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aactab.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}aacenctab.\+h\char`\"{}}\newline
Include dependency graph for aaccoder\+\_\+twoloop.\+h\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{aaccoder__twoloop_8h__incl}
\end{center}
\end{figure}
This graph shows which files directly or indirectly include this file\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=215pt]{aaccoder__twoloop_8h__dep__incl}
\end{center}
\end{figure}
\doxysubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{aaccoder__twoloop_8h_af3b33fe7bf17f011bcec0708f8e679f9}{N\+O\+I\+S\+E\+\_\+\+L\+O\+W\+\_\+\+L\+I\+M\+IT}}~4000
\item 
\#define \mbox{\hyperlink{aaccoder__twoloop_8h_a2cd75b991aca30a0bd1df6e2d3a265c2}{sclip}}(x)~av\+\_\+clip(x,60,218)
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static \mbox{\hyperlink{ffmpeg__filter_8c_a61569f2965b7a369eb10b6d75d410d11}{int}} \mbox{\hyperlink{aaccoder__twoloop_8h_a393c88eecd9e7d821e9502c96e8a8f4e}{ff\+\_\+pns\+\_\+bits}} (\mbox{\hyperlink{struct_single_channel_element}{Single\+Channel\+Element}} $\ast$sce, \mbox{\hyperlink{ffmpeg__filter_8c_a61569f2965b7a369eb10b6d75d410d11}{int}} \mbox{\hyperlink{sw__rgb_8c_aba9ed0487b0aa23eba534648df8384c0}{w}}, \mbox{\hyperlink{ffmpeg__filter_8c_a61569f2965b7a369eb10b6d75d410d11}{int}} \mbox{\hyperlink{yuv2rgb_8c_a73c18c59a39b18382081ec00bb456d43}{g}})
\item 
static \mbox{\hyperlink{rematrix__template_8c_a4dfdfbb7b69470f1152e022432ee2d45}{void}} \mbox{\hyperlink{aaccoder__twoloop_8h_aeb6d209421a5b22371165a9ab8eb3301}{search\+\_\+for\+\_\+quantizers\+\_\+twoloop}} (\mbox{\hyperlink{struct_a_v_codec_context}{A\+V\+Codec\+Context}} $\ast$avctx, \mbox{\hyperlink{struct_a_a_c_enc_context}{A\+A\+C\+Enc\+Context}} $\ast$\mbox{\hyperlink{sw__rgb_8c_a517a4433fe5466cc6af1c80c538b0881}{s}}, \mbox{\hyperlink{struct_single_channel_element}{Single\+Channel\+Element}} $\ast$sce, const float lambda)
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
A\+AC encoder twoloop coder \begin{DoxyAuthor}{Author}
Konstantin Shishkov, Claudio Freire 
\end{DoxyAuthor}


\doxysubsection{Macro Definition Documentation}
\mbox{\Hypertarget{aaccoder__twoloop_8h_af3b33fe7bf17f011bcec0708f8e679f9}\label{aaccoder__twoloop_8h_af3b33fe7bf17f011bcec0708f8e679f9}} 
\index{aaccoder\_twoloop.h@{aaccoder\_twoloop.h}!NOISE\_LOW\_LIMIT@{NOISE\_LOW\_LIMIT}}
\index{NOISE\_LOW\_LIMIT@{NOISE\_LOW\_LIMIT}!aaccoder\_twoloop.h@{aaccoder\_twoloop.h}}
\doxysubsubsection{\texorpdfstring{NOISE\_LOW\_LIMIT}{NOISE\_LOW\_LIMIT}}
{\footnotesize\ttfamily \#define N\+O\+I\+S\+E\+\_\+\+L\+O\+W\+\_\+\+L\+I\+M\+IT~4000}

This file contains a template for the twoloop coder function. It needs to be provided, externally, as an already included declaration, the following functions from aacenc\+\_\+quantization/util.\+h. They\textquotesingle{}re not included explicitly here to make it possible to provide alternative implementations\+:
\begin{DoxyItemize}
\item quantize\+\_\+band\+\_\+cost
\item abs\+\_\+pow34\+\_\+v
\item find\+\_\+max\+\_\+val
\item find\+\_\+min\+\_\+book
\item find\+\_\+form\+\_\+factor Frequency in Hz for lower limit of noise substitution 
\end{DoxyItemize}

Definition at line 54 of file aaccoder\+\_\+twoloop.\+h.

\mbox{\Hypertarget{aaccoder__twoloop_8h_a2cd75b991aca30a0bd1df6e2d3a265c2}\label{aaccoder__twoloop_8h_a2cd75b991aca30a0bd1df6e2d3a265c2}} 
\index{aaccoder\_twoloop.h@{aaccoder\_twoloop.h}!sclip@{sclip}}
\index{sclip@{sclip}!aaccoder\_twoloop.h@{aaccoder\_twoloop.h}}
\doxysubsubsection{\texorpdfstring{sclip}{sclip}}
{\footnotesize\ttfamily \#define sclip(\begin{DoxyParamCaption}\item[{}]{x }\end{DoxyParamCaption})~av\+\_\+clip(x,60,218)}



Definition at line 56 of file aaccoder\+\_\+twoloop.\+h.



\doxysubsection{Function Documentation}
\mbox{\Hypertarget{aaccoder__twoloop_8h_a393c88eecd9e7d821e9502c96e8a8f4e}\label{aaccoder__twoloop_8h_a393c88eecd9e7d821e9502c96e8a8f4e}} 
\index{aaccoder\_twoloop.h@{aaccoder\_twoloop.h}!ff\_pns\_bits@{ff\_pns\_bits}}
\index{ff\_pns\_bits@{ff\_pns\_bits}!aaccoder\_twoloop.h@{aaccoder\_twoloop.h}}
\doxysubsubsection{\texorpdfstring{ff\_pns\_bits()}{ff\_pns\_bits()}}
{\footnotesize\ttfamily static \mbox{\hyperlink{ffmpeg__filter_8c_a61569f2965b7a369eb10b6d75d410d11}{int}} ff\+\_\+pns\+\_\+bits (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{struct_single_channel_element}{Single\+Channel\+Element}} $\ast$}]{sce,  }\item[{\mbox{\hyperlink{ffmpeg__filter_8c_a61569f2965b7a369eb10b6d75d410d11}{int}}}]{w,  }\item[{\mbox{\hyperlink{ffmpeg__filter_8c_a61569f2965b7a369eb10b6d75d410d11}{int}}}]{g }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}, {\ttfamily [static]}}



Definition at line 59 of file aaccoder\+\_\+twoloop.\+h.

Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{aaccoder__twoloop_8h_a393c88eecd9e7d821e9502c96e8a8f4e_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{aaccoder__twoloop_8h_aeb6d209421a5b22371165a9ab8eb3301}\label{aaccoder__twoloop_8h_aeb6d209421a5b22371165a9ab8eb3301}} 
\index{aaccoder\_twoloop.h@{aaccoder\_twoloop.h}!search\_for\_quantizers\_twoloop@{search\_for\_quantizers\_twoloop}}
\index{search\_for\_quantizers\_twoloop@{search\_for\_quantizers\_twoloop}!aaccoder\_twoloop.h@{aaccoder\_twoloop.h}}
\doxysubsubsection{\texorpdfstring{search\_for\_quantizers\_twoloop()}{search\_for\_quantizers\_twoloop()}}
{\footnotesize\ttfamily static \mbox{\hyperlink{rematrix__template_8c_a4dfdfbb7b69470f1152e022432ee2d45}{void}} search\+\_\+for\+\_\+quantizers\+\_\+twoloop (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{struct_a_v_codec_context}{A\+V\+Codec\+Context}} $\ast$}]{avctx,  }\item[{\mbox{\hyperlink{struct_a_a_c_enc_context}{A\+A\+C\+Enc\+Context}} $\ast$}]{s,  }\item[{\mbox{\hyperlink{struct_single_channel_element}{Single\+Channel\+Element}} $\ast$}]{sce,  }\item[{const float}]{lambda }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}

two-\/loop quantizers search taken from I\+SO 13818-\/7 Appendix C rdlambda controls the maximum tolerated distortion. Twoloop will keep iterating until it fails to lower it or it reaches ulimit $\ast$ rdlambda. Keeping it low increases quality on difficult signals, but lower it too much, and bits will be taken from weak signals, creating \char`\"{}holes\char`\"{}. A balance is necessary. rdmax and rdmin specify the relative deviation from rdlambda allowed for tonality compensation

sfoffs controls an offset of optmium allocation that will be applied based on lambda. Keep it real and modest, the loop will take care of the rest, this just accelerates convergence

zeroscale controls a multiplier of the threshold, if band energy is below this, a zero is forced. Keep it lower than 1, unless low lambda is used, because energy $<$ threshold doesn\textquotesingle{}t mean there\textquotesingle{}s no audible signal outright, it\textquotesingle{}s just energy. Also make it rise slower than rdlambda, as rdscale has due compensation with noisy band depriorization below, whereas zeroing logic is rather dumb

Psy granted us extra bits to use, from the reservoire adjust for lambda except what psy already did

Constant Q-\/scale doesn\textquotesingle{}t compensate MS coding on its own No need to be overly precise, this only controls RD adjustment CB limits when going overboard

When using a constant Q-\/scale, don\textquotesingle{}t adjust bits, just use RD Don\textquotesingle{}t let it go overboard, though... 8x psy target is enough

Don\textquotesingle{}t offset scalers, just RD

search further

and zero out above cutoff frequency

Scale, psy gives us constant quality, this LP only scales bitrate by lambda, so we save bits on subjectively unimportant HF rather than increase quantization noise. Adjust nominal bitrate to effective bitrate according to encoding parameters, A\+A\+C\+\_\+\+C\+U\+T\+O\+F\+F\+\_\+\+F\+R\+O\+M\+\_\+\+B\+I\+T\+R\+A\+TE is calibrated for effective bitrate.

Compensate for extensions that increase efficiency

for values above this the decoder might end up in an endless loop due to always having more bits than what can be encoded.

X\+XX\+: some heuristic to determine initial quantizers will reduce search time determine zero bands and upper distortion limits

Compute initial scalers

log2f-\/to-\/distortion ratio is, technically, 2 (1.\+5db = 4, but it\textquotesingle{}s power vs level so it\textquotesingle{}s 2). But, as offsets are applied, low-\/frequency signals are too sensitive to the induced distortion, so we make scaling more conservative by choosing a lower log2f-\/to-\/distortion ratio, and thus more robust.

Clip

Scale uplims to match rate distortion to quality bu applying noisy band depriorization and tonal band priorization. Maxval-\/energy ratio gives us an idea of how noisy/tonal the band is. If maxval$^\wedge$2 $\sim$ energy, then that band is mostly noise, and we can relax rate distortion requirements.

psy already priorizes transients to some extent

In A\+BR, we need to priorize less and let rate control do its thing

In A\+BR, we need to priorize less and let rate control do its thing

P\+NS isn\textquotesingle{}t free

Must recompute distortion

P\+NS isn\textquotesingle{}t free

Start with big steps, end up fine-\/tunning

Um... over target. Save bits for more important stuff.

SF difference limit violation risk. Must re-\/clamp.

Scout out next nonzero bands

Make sure proper codebooks are set

Cannot zero out, make sure it\textquotesingle{}s not attempted

Check that there\textquotesingle{}s no SF delta range violations

Set global gain to something useful

Definition at line 67 of file aaccoder\+\_\+twoloop.\+h.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{aaccoder__twoloop_8h_aeb6d209421a5b22371165a9ab8eb3301_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{aaccoder__twoloop_8h_aeb6d209421a5b22371165a9ab8eb3301_icgraph}
\end{center}
\end{figure}
